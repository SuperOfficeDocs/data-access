---
title: How to authenticate an application user
uid: auth_user_oidc
description: How to authenticate an application user
author: {github-id}
keywords: authentication, OAuth 2.0, OIDC, authorization code flow, implicit flow
so.topic: howto
so.envir: cloud
so.client: online
---

# How to authenticate an application user

Let's look at how you can authenticate an application user with OAuth 2.0.

## OAuth Authorization Code Flow

In the Authorization code flow, an end-user accesses a client application that requires the user to authenticate. After clicking login, the partner application redirects the user agent, typically a browser, to the authorization endpoint of the Identity Provider.

![oauth-code-flow][img1]

### Start the flow

The user agent sends a request to the Identity Provider authorization URI with the following information:

```http
GET https://sod.superoffice.com/login/common/oauth/authorize?
  client_id=c789b7d98f3c496fb5aaa4b1a81ca11b&
  scope=openid&
  redirect_uri=https://partnerapp/callback&
  state=12345&
  response_type=code&
```

| Parameter | Required | Description |
|---|---|---|
| client_id | yes | The Application Id assigned to your app when you registered it with SuperOffice. |
| scope | yes | Must be `openid`. |
| redirect_uri | yes | The redirect_uri of your app, where authentication responses are sent and received by your app.<br>It *must* exactly match one of the redirect_uris registered with SuperOffice. |
| state | no (recommended) | A value included in the request that is also returned in the token response. |
| response_type | yes | Must include `code` for the authorization code flow. |
| response_mode | no (optional) | Can be `fragment` and returns parameters in URI after hash #,or `form_data` and returns values in form data. |

The user is then directed to the authentication server login screen, where they enter their credentials. An Identity Provider authenticates the user and asks for consent to access their resources on behalf of the Relying Party.

```http!
GET https://sod.superoffice.com/login/common/oauth/authorize?client_id=c789b7d98f3c496fb5aaa4b1a81ca11b&scope=openid&redirect_uri=http://localhost/DevNet-MvcIntegrationServerApp/callback&state=12345&response_type=code
Accept: application/json
```

### SuperID redirects to app

With consent given by the user, the SuperId server sends an authorization response message from its authorization endpoint. This redirects the user agent back to the relying party using the redirection URI provided earlier. This URI includes an authorization code and any state provided by the client earlier.

```http
GET https://localhost/DevNet-MvcIntegrationServerApp/callback?
  state=12345&
  code=o0NWI5leHdUflrjlTVVKqbSOt3n9Od0ZrBUq0nXFWKszyOdOZchk60fTf4pDWTFT
```

| Parameter | Description |
|---|---|
| code | The authorization code generated by the authorization server. The authorization code expires after 10 minutes. |
| state | The exact value received from the client. |

### App requests access token from SuperID

The app (the relying party) then requests an ID token to the token endpoint by sending the client ID, client secret, the Authorization code, the redirect URI, and the Grant Type to SuperId (the authentication service).

```http
POST https://sod.superoffice.com/login/common/oauth/tokens?
  client_id=c789b7d98f3c496fb5aaa4b1a81ca11b&
  client_secret=83d0f3bcb9afbc7eb9d0682e9b86db52&
  code=o0NWI5leHdUflrjlTVVKqbSOt3n9Od0ZrBUq0nXFWKszyOdOZchk60fTf4pDWTFT&
  redirect_uri=http://localhost/DevNet-MvcIntegrationServerApp/callback&
  grant_type=authorization_code&
```

| Parameter | Required | Description |
|---|---|---|
| client_id | yes | The Application Id assigned to your app when you registered it with SuperOffice. |
| client_secret | yes | The Application Token assigned to your app when you registered it with SuperOffice. |
| code | yes | The authorization code that the application requested. The application can use the authorization code to request an access token for the target resource. |
| redirect_uri | yes | The redirect_uri of your app, where authentication responses are sent and received by your app. It must exactly match one of the redirect_uris registered with SuperOffice. |
| grant_type | yes | Must be `authorization_code` for the authorization code flow. |

SuperID (the Identity provider) authenticates the client using the client ID and secret and validates the redirect URI. When the grant type is set to authorization_code, the identity provider will validate the code parameter. Alternatively, the grant_type is set to refresh_token and the provider will validate the refresh_token parameter.

If valid, the Identity Provider responds with the ID token from the token endpoint. The response also includes an access token and an optional refresh token. The client validates the ID token, and if successful, the identity is proven and the Authorization Code flow is complete.

```http!
POST https://sod.superoffice.com/login/common/oauth/tokens?client_id=c789b7d98f3c496fb5aaa4b1a81ca11b&client_secret=83d0f3bcb9afbc7eb9d0682e9b86db52&code=o0NWI5leHdUflrjlTVVKqbSOt3n9Od0ZrBUq0nXFWKszyOdOZchk60fTf4pDWTFT&redirect_uri=http://localhost/DevNet-MvcIntegrationServerApp/callback&grant_type=authorization_code
Content-Type: application/json
Accept: application/json
```

**Post response:**

```json
{
  "token_type": "Bearer",
  "access_token": "8A:Cust12020.AR2s3phb0gXK8DP0NfoYlsrQAQAACIJ/KQ+cbGp0l9g8PJNlBCEZxS/1hL3Cxt8ITWlQipRbdknTbIFxUuUChHj4U1qUlP6/dJA+aKE1psfT8F4XwFlYBjvw6xmM086Vckm0Mmh+fEPuoLspl+EgtQzD0F8Ka4qLFGWICvUg==",
  "expires_in": 3600,
  "refresh_token": "KSamN1Tp4sd26pZJSGK6JobrWOUWorIZ2Y5XxcAqX86K9qoZRp4d3lUH32F4fiT3",
  "id_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IkZyZjdqRC1hc0dpRnFBREdUbVRKZkVxMTZZdyJ9.enLw7oTQ9DkuluduWDMcdHYfmImeVNDC93txA_njdmta45ZG0VBeG9lrxInXMdxWXqb_W-ogEaHYbkfugMXwlim7V1c38Wl8QR9QVNImFACzmdma_HBILmUDK9f4XdTA93TnB-WYhesJ_tvdmzrScMIFKANvNNT3smxec6ST-j1uCUBCQrVNxILapXiUrJER4aMmAbFweWs9bbgfhR9_sQVQDmLbVw"
}
```

| Parameter | Description |
|---|---|
| access_token | The access token issued by the authorization server. |
| token_type | Provides the client with the information required to successfully utilize the access token to make a protected resource request. |
| expires_in | The lifetime in seconds of the access token. |
| refresh_token | The refresh token, which can be used to obtain new access tokens. The refresh token is a long-lived token that can be re-used. It is coupled to an end-users consent and is valid as long as the application authorization record (consent) exists. Tenants can revoke authorizations. |
| id_token | JSON Web Token (JWT), which consists of a Header, Payload, and Signature. The claims in the token form part of the payload. This can be used to verify that the tokens came from the real SuperId server. |

This gives you the access token directly, as well as the refresh token (which is used to get more access tokens), and the JWT.

You will want to keep the refresh_token and access_token if the JWT is valid.

### Verify the JWT

To verify the JWT you need to use a PKCS certificate (there is one per environment)

The ID Token is encoded as a JSON Web Token or JWT, which consists of a Header, Payload, and Signature. These elements are delimited by a period. The claims in the token form part of the payload.

![JWT Claims][img2]

The actual verification involves cryptography, and you are best off using a library like .net [System.IdentityModel.Tokens.Jwt][6] or Node [jsonwebtoken][7]. See [jwt.io][8] for a bigger list of libraries.

Here is some Node/JavaScript code that does the verification:

```javascript
request(`https://sod.superoffice.com/login/common/oauth/tokens`, {
    method: 'POST',  
    body: {
      code: inputData.code,
      client_id: process.env.CLIENT_ID,
      client_secret: process.env.CLIENT_SECRET,
      grant_type: 'authorization_code',
      redirect_uri: process.env.REDIRECT_URL
    },
    headers: {
      'content-type': 'application/x-www-form-urlencoded',
      'accept': 'application/json'
    }
}).then( response => {
    const result = JSON.parse(response.content);
    const options = { };
    const cert = "-----BEGIN CERTIFICATE-----\n"+
      "MIIDqzCCApMCAQgwDQYJKoZIhvcNAQEFBQAwgZMxCzAJBgNVBAYTAk5PMQ0wCwYD\n"++++...;
    const jwt_token = jwt.verify(result.id_token, cert, options);
})
```

The verify call will throw an error if the `id_token` is not signed by the certificate.

### Call the WebAPI with the access token

You can now make a request to the WebAPI using the access token:

```http
GET /api/v1/contact/2
Authorization: Bearer 8A:Cust12020.AR2s3phb0gXK8DP0NfoYlsrQAQAACIJ/KQ+cbGp-0l9g8PJNlBCEZxS/1hL3Cxt8ITWlQipRbdknTbIFxUuUChHj4U1qUlP6/dJA+aKE1psfT8F4Xw-FlYBjvw6xmM086Vckm0Mmh+fEPuoLspl+EgtQzD0F8Ka4qLFGWICvUg==
Accept: application/json
```

This access token contains your application's identity and the user's identity.

You should get a valid response back.

```json
{
  "TableRight": {
      "Mask": "RI, RestrictedUpdate",
      "Reason": "[SR_ACCESS_ASSOCCONT_DELETE]"
  },
  "FieldProperties": { ... },
  "ContactId": 2,
  "Name": "statezerodatabase",
  "Department": "",
  "OrgNr": "",
  "Number1": "",
  "Number2": "",
  "UpdatedDate": "2016-01-04T13:27:28",
  "CreatedDate": "2002-07-23T15:14:29",
  "Emails": [],
```

## Expired access tokens

If the access token has expired, you will get an HTTP 401 error back (unauthorized).

You will need to use the refresh token to get a new access token. With the new access token, you can re-try the request.

A user's refresh_token is valid for the lifetime of the application, or until it has been revoked. A refresh_token is used in a POST request to generate a new access token as follows:

```http
POST https://sod.superoffice.com/login/common/oauth/tokens?
grant_type=refresh_token&
client_id=4ref5376616343b38d14ddcd804f2654&
client_secret=18f45229e442772a78df5f554e24a456&
refresh_token=nKHwerkjh34Yd6QShsnGKk4cFhTwCv3XtJu9PW2X63MtUMygLdI57BJjwCU0&
redirect_url=http://partnerapp/callback
```

| Parameter | Required | Description |
|---|---|---|
| grant_type | yes | Must be set to `refresh_token` |
| client_id | yes| The Application ID assigned to your app when you registered it with SuperOffice. |
| client_secret | yes | The Application Secret assigned to your app when you registered it with SuperOffice. |
| refresh_token | yes | The refresh token issued as one of the response items in the Authorization Code Flow. |
| redirect_uri | no | The redirect_uri of your app, where authentication responses are sent and received by your app. It must exactly match one of the redirect_uris registered with SuperOffice. |
| scope | no | SuperOffice only supports the scope *openid* and is implicit for each flow. |

The response contains the token type, access token, expiration in seconds, and identity token.

```json
{
  "token_type": "Bearer",
  "access_token": "8A:Cust12345.AZuHwfgrRZPHqdjhQyay34ggAgAA8z5BnSYUSk4U4sdfr1Bjzycu0S1NC+xvghQ4VoUz9r6xpF2YAOCj0rb3LWnjLqllp3fYk8h2sxwc8d+5nb5bzGvHLHJ1UIRk38Ye4dPpmLSr4B8UaYNc9gs4Wgfgxqtii+o5fcB7lbVaVLFGmjUj1jgtIzVKiAR9eyMiWXL3dWMg+WM2Y0MOTsUrSb10kXkJ4g3M4TvH3rV4HTK3ohToxUleYvFbarx/8jeO7oLJfn3nth8NGtd1lJ",
  "expires_in": 3600,
  "id_token": "eyJ0eFor_Demonstration_PurposeszI1NiIsIng1dCI6IkZyZjdqRC1hc0dpRnFBREdUbVRKZkVxMTZZdyJ9.For_Demonstration_PurposesbSIsImh0dHA6Ly9zY2hlbWVzLnN1cGVyb2ZmaWNlLm5ldC9pZGVudGl0eS9hGl0eS9uZXRzZXJ2ZXJfdXJsIjoiaHR0cHM6Ly9zb2Quc3VwZXJvZmZpY2UuY29tL0N1c3QyNjc1OS9SZW1vdGUvThrOFE3RG1CZ28iLCJpYXQiOiIxNTQ2NjEzMTk4IiwiaXNzIjoiaHR0cHM6Ly9zb2Quc3VwZXJvZmZpY2UuY29tqStzCXqhSjd1u7FjsJhqr1xGLDqLzkOm9_0v0nWFHESjBuPhFPIdt6lmcCuy48HGg5G0eM1_3h6SESsukXe0hNMqp3ZHjm5dCEoxE4HziLWSdRZIUa6tkP6wfHDHU_XUJu7PHo8Wx5aG9IBPZ_r1Xd8mgmt6g"
}
```

## Implicit Flow

This procedure uses an [Implicit Flow][1] request. The **client ID** is necessary to link the user to an application definition where the redirect URL is specified.

### Pre-requisites

* You have received a unique [client ID and secret][2]
* You have whitelisted your [redirect URL][3] with SuperOffice
* You have set up a web page at your redirect URL
* The application user has a valid username and password

> [!TIP]
> Remember that the sub-domain is different for [development, stage, and production][4]. Very likely the client ID differs too.

### To authenticate users

1. Forward the user to the SuperOffice CRM Online **sign-in page** to authenticate.

    ```javascript
    https://{env}.superoffice.com/login/common/oauth/authorize?response_type=id_token token
    &client_id=YOUR-APP-ID&redirect_uri=YOUR-REDIRECT-URL&scope=openid&state=12345
    &nonce=7362CAEA-9CA5-4B43-9BA3-34D7C303EBA7
    ```

2. Receive the **authentication token** when the sign-in page redirects the user back to your application.

3. [Validate the authentication token][5].

> [!WARNING]
> No application is allowed to ask users for their credentials, ever!

**Next step:** implement your application-specific logic.

<!-- Referenced links -->
[1]: implicit-flow.md
[2]: ../../../../../superoffice-docs/docs/apps/terminology.md
[3]: ../../../../../superoffice-docs/docs/apps/redirects/index.md
[4]: ../../../../../superoffice-docs/docs/apps/getting-started/app-envir.md
[5]: ../validate-security-tokens.md
[6]: https://www.nuget.org/packages/System.IdentityModel.Tokens.Jwt/
[7]: https://github.com/auth0/node-jsonwebtoken
[8]: https://jwt.io/

<!-- Referenced images -->
[img1]: media/oauth-code-flow.png
[img2]: ../media/id-token.png
